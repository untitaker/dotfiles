#!/bin/bash
main() {
    echo "Starting new session..."
    source /etc/X11/xinit/xinitrc.d/50-systemd-user.sh
    source ~/.bash_profile

    sxhkd -f 100 &
    twmnd &

    set_wallpaper &
    statusbar &

    source ~/.xstart_$(hostname)

    #trayer --edge top --widthtype request --align center --SetDockType true --SetPartialStrut true --expand true --transparent true --alpha 0 --tint 0x000000 --height 16 &

    while true; do
        output="$(dwm 2>&1)"
        if [ $? = 0 ]; then break; fi
        echo "dwm crashed or was killed. Output:"
        echo "$output"

        if echo "$output" | grep -q "another window manager"; then
            echo "Other window manager running, waiting a bit..."
            sleep 5
            continue
        elif echo "$output" | grep -qi "fatal error"; then
            echo "Fatal error?!"
            notify-send "dwm crashed" &
            openbox
            break
        fi

        echo "Recompiling dwm"
        cd ~/.homesick/repos/dotfiles/
        make config-reload
    done  # restart dwm only if its been killed manually
}
