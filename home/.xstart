#!/bin/bash
set_escape_key() {
    xmodmap -e 'clear Lock' -e 'keycode 0x42 = Escape'
}

main() {
    echo "Starting new session..."
    xrdb -merge ~/.dotfiledata/base16_xresources/base16-tomorrow.dark.xresources
    source /etc/X11/xinit/xinitrc.d/30-dbus
    source ~/.bash_profile

    # Start the GnuPG agent and enable OpenSSH agent emulation
    eval $(keychain --eval -Q ~/.ssh/id_*)

    twmnd &

    xbindkeys &
    (set_escape_key && sleep 5 && set_escape_key) &  # help, why does it only work like this
    xsetroot -cursor_name left_ptr &
    set_wallpaper &

    source ~/.xstart_$(hostname)

    statusbar right &
    while ! ps -A | grep dzen2; do
        sleep 0.1
    done

    trayer --edge top --widthtype request --align center --SetDockType true --SetPartialStrut true --expand true --transparent true --alpha 0 --tint 0x000000 --height 16 &

    xmonad # if xmonad exits, everything will be killed
}
