#!/bin/sh
set -e

watch() {
    local path="$1"
    local collection="$(echo $path | sed -e 's/\/home\/untitaker\/\.//')"
    echo "Watching $collection"
    while inotifywait -rq -e create -e delete -t 1200 "$path"; do
        sleep 0.1
        if vdirsyncer sync "$collection"; then
            echo "$collection finished"
        else
            printf "%s%s finished with %s%s" "$C_RED" "$collection" "$?" "$C_RESET"
        fi
    done
}

for dir in ~/.calendars/* ~/.contacts; do
    watch "$dir" &
done
wait
